<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RR GU Analytic Tracker - Live Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .metric-card {
            transition: transform 0.2s ease-in-out;
        }
        .metric-card:hover {
            transform: translateY(-2px);
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #10b981; }
        .status-loading { background-color: #f59e0b; animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="text-3xl">üßü‚Äç‚ôÇÔ∏è</div>
                    <div>
                        <h1 class="text-3xl font-bold text-white">RR GU Analytic Tracker</h1>
                        <p class="text-blue-100">Real-time NFT migration analytics</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-white text-sm font-semibold" id="currentDate">September 4, 2025</div>
                        <div class="text-blue-100 text-xs" id="lastUpdate">Loading...</div>
                    </div>
                    <span class="status-indicator status-loading" id="statusIndicator"></span>
                    <div class="flex space-x-3">
                        <button onclick="refreshData()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg transition-all duration-200">
                            <i class="fas fa-refresh mr-2"></i>Refresh
                        </button>
                        <button onclick="shareToTwitter()" class="bg-green-600 bg-opacity-90 hover:bg-opacity-100 text-white px-4 py-2 rounded-lg transition-all duration-200">
                            <i class="fab fa-twitter mr-2"></i>Share
                        </button>
                        <button onclick="exportReport()" class="bg-purple-600 bg-opacity-90 hover:bg-opacity-100 text-white px-4 py-2 rounded-lg transition-all duration-200">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <!-- ETH Price Banner -->
        <div class="card rounded-xl shadow-lg p-6 mb-8">
            <div class="flex justify-center items-center space-x-4">
                <div class="text-2xl">‚ü†</div>
                <div class="text-center">
                    <div class="text-sm text-gray-600 uppercase tracking-wide">Ethereum Price</div>
                    <div class="text-3xl font-bold text-gray-800" id="ethPrice">$--,---</div>
                </div>
            </div>
        </div>

        <!-- Collection Metrics -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- GU Origins -->
            <div class="card rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">GU Origins</h2>
                    <div class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">Source</div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="metric-card bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Floor Price</div>
                        <div class="text-xl font-bold text-gray-800" id="originsFloorETH">-.---- ETH</div>
                        <div class="text-sm text-gray-500" id="originsFloorUSD">$---</div>
                        <div class="text-xs font-medium mt-1" id="originsFloorChange24h">--%</div>
                    </div>
                    
                    <div class="metric-card bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">24h Volume <span class="text-xs text-amber-600" title="OpenSea API rate limited">‚ö†Ô∏è</span></div>
                        <div class="text-xl font-bold text-gray-800" id="originsVolume">-.-- ETH</div>
                        <div class="text-sm text-gray-500" id="originsVolumeUSD">$---</div>
                    </div>
                    
                    <div class="metric-card bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Market Cap</div>
                        <div class="text-xl font-bold text-gray-800" id="originsMarketCap">$--M</div>
                    </div>
                    
                    <div class="metric-card bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Total Supply</div>
                        <div class="text-xl font-bold text-gray-800" id="originsHolders">-,---</div>
                    </div>
                </div>
            </div>

            <!-- Genuine Undead -->
            <div class="card rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Genuine Undead</h2>
                    <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">Destination</div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="metric-card bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Floor Price</div>
                        <div class="text-xl font-bold text-gray-800" id="undeadFloorETH">-.---- ETH</div>
                        <div class="text-sm text-gray-500" id="undeadFloorUSD">$---</div>
                        <div class="text-xs font-medium mt-1" id="undeadFloorChange24h">--%</div>
                    </div>
                    
                    <div class="metric-card bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">24h Volume <span class="text-xs text-amber-600" title="OpenSea API rate limited">‚ö†Ô∏è</span></div>
                        <div class="text-xl font-bold text-gray-800" id="undeadVolume">-.-- ETH</div>
                        <div class="text-sm text-gray-500" id="undeadVolumeUSD">$---</div>
                    </div>
                    
                    <div class="metric-card bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Market Cap</div>
                        <div class="text-xl font-bold text-gray-800" id="undeadMarketCap">$--M</div>
                    </div>
                    
                    <div class="metric-card bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Total Supply</div>
                        <div class="text-xl font-bold text-gray-800" id="undeadHolders">-,---</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Migration Stats -->
        <div class="card rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Migration Analytics - Last 30 Days</h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="totalMigrations">---</div>
                    <div class="text-sm text-gray-600">Total Migrations</div>
                    <div class="text-xs text-gray-500">Origins ‚Üí Undead</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="migrationPercent">---%</div>
                    <div class="text-sm text-gray-600">% Migrated</div>
                    <div class="text-xs text-gray-500">% of Origins supply</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600" id="floorPriceRatio">-.--x</div>
                    <div class="text-sm text-gray-600">Price Ratio</div>
                    <div class="text-xs text-gray-500">GU/Origins</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-orange-600" id="recentMigrations">+0</div>
                    <div class="text-sm text-gray-600">New Migrations</div>
                    <div class="text-xs text-gray-500">vs 5,333 baseline</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-indigo-600" id="marketCapChange">+0.0%</div>
                    <div class="text-sm text-gray-600">30-Day MC Change</div>
                    <div class="text-xs text-gray-500">vs $3.27M baseline</div>
                </div>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-16">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2025 RR GU Analytic Tracker. Built with ‚ù§Ô∏è for the GU community.</p>
            <div class="mt-4 space-x-4">
                <a href="https://opensea.io/collection/gu-origins" target="_blank" class="text-blue-400 hover:text-blue-300">GU Origins ‚Üó</a>
                <a href="https://opensea.io/collection/genuine-undead" target="_blank" class="text-blue-400 hover:text-blue-300">Genuine Undead ‚Üó</a>
            </div>
        </div>
    </footer>

    <script>
        let isLoading = false;

        function formatNumber(num, decimals = 0) {
            if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return num.toFixed(decimals);
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(num);
        }

        function updateStatus(loading) {
            const indicator = document.getElementById('statusIndicator');
            const dashboard = document.querySelector('body');
            
            if (loading) {
                indicator.className = 'status-indicator status-loading';
                dashboard.classList.add('loading');
                isLoading = true;
            } else {
                indicator.className = 'status-indicator status-online';
                dashboard.classList.remove('loading');
                isLoading = false;
            }
        }

        function updateUI(data) {
            console.log('Updating UI with data:', data);
            
            // ETH Price - handle NaN/null
            const ethPrice = data.eth_price_usd || 4382;
            if (isNaN(ethPrice)) {
                console.error('ETH price is NaN:', data.eth_price_usd);
                document.getElementById('ethPrice').textContent = '$4,382';
            } else {
                document.getElementById('ethPrice').textContent = formatCurrency(ethPrice);
            }
            
            // Origins data
            if (data.origins) {
                document.getElementById('originsFloorETH').textContent = data.origins.floor_price_eth.toFixed(4) + ' ETH';
                document.getElementById('originsFloorUSD').textContent = formatCurrency((data.origins.floor_price_eth * ethPrice));
                document.getElementById('originsVolume').textContent = data.origins.volume_24h_eth.toFixed(2) + ' ETH';
                document.getElementById('originsVolumeUSD').textContent = formatCurrency((data.origins.volume_24h_eth * ethPrice));
                document.getElementById('originsMarketCap').textContent = formatCurrency(data.origins.market_cap_usd);
                document.getElementById('originsHolders').textContent = (data.origins.holders_count || data.origins.total_supply || 0).toLocaleString();
                
                // 24h floor price change
                const originsChange = data.origins.floor_change_24h || 0;
                const originsChangeElement = document.getElementById('originsFloorChange24h');
                originsChangeElement.textContent = (originsChange >= 0 ? '+' : '') + originsChange.toFixed(1) + '%';
                originsChangeElement.className = 'text-xs font-medium mt-1 ' + (originsChange >= 0 ? 'text-green-600' : 'text-red-600');
            }
            
            // Undead data
            if (data.undead) {
                document.getElementById('undeadFloorETH').textContent = data.undead.floor_price_eth.toFixed(4) + ' ETH';
                document.getElementById('undeadFloorUSD').textContent = formatCurrency((data.undead.floor_price_eth * ethPrice));
                document.getElementById('undeadVolume').textContent = data.undead.volume_24h_eth.toFixed(2) + ' ETH';
                document.getElementById('undeadVolumeUSD').textContent = formatCurrency((data.undead.volume_24h_eth * ethPrice));
                document.getElementById('undeadMarketCap').textContent = formatCurrency(data.undead.market_cap_usd);
                document.getElementById('undeadHolders').textContent = (data.undead.holders_count || data.undead.total_supply || 0).toLocaleString();
                
                // 24h floor price change
                const undeadChange = data.undead.floor_change_24h || 0;
                const undeadChangeElement = document.getElementById('undeadFloorChange24h');
                undeadChangeElement.textContent = (undeadChange >= 0 ? '+' : '') + undeadChange.toFixed(1) + '%';
                undeadChangeElement.className = 'text-xs font-medium mt-1 ' + (undeadChange >= 0 ? 'text-green-600' : 'text-red-600');
            }
            
            // Migration analytics with proper calculations
            const migration = data.migration_analytics?.migration_rate || {};
            const totalMigrations = migration.total_migrations || 0;
            const migrationPercent = migration.migration_percent || 0;
            
            document.getElementById('totalMigrations').textContent = totalMigrations.toLocaleString();
            
            // Use calculated migration percentage (migrations / 10,000 Origins)
            document.getElementById('migrationPercent').textContent = migrationPercent.toFixed(2) + '%';
            
            // Price ratio (GU vs Origins) - show premium/discount
            if (data.origins && data.undead && data.origins.floor_price_eth > 0) {
                const ratio = data.undead.floor_price_eth / data.origins.floor_price_eth;
                document.getElementById('floorPriceRatio').textContent = ratio.toFixed(2) + 'x';
                
                // Visual indicator for premium/discount
                const ratioElement = document.getElementById('floorPriceRatio');
                if (ratio > 1) {
                    ratioElement.className = 'text-2xl font-bold text-red-600'; // Premium (more expensive)
                } else {
                    ratioElement.className = 'text-2xl font-bold text-green-600'; // Discount (cheaper)
                }
            }
            
            // Calculate new migrations vs baseline
            const currentMigrations = data.migration_analytics.migration_rate.total_migrations || 5333;
            const baseMigrations = 5333;
            const newMigrations = currentMigrations - baseMigrations;
            document.getElementById('recentMigrations').textContent = newMigrations >= 0 ? `+${newMigrations}` : `${newMigrations}`;
            
            // Calculate market cap change vs baseline  
            const currentMarketCap = data.ecosystem_value || 0;
            const baselineMarketCap = 3270218;
            const marketCapChange = ((currentMarketCap - baselineMarketCap) / baselineMarketCap) * 100;
            document.getElementById('marketCapChange').textContent = marketCapChange >= 0 ? `+${marketCapChange.toFixed(1)}%` : `${marketCapChange.toFixed(1)}%`;
            
            // Ecosystem value - not displayed in current layout
            // Total value calculated but not shown on dashboard
            
            // Date and time update
            const now = new Date(data.timestamp);
            const dateOptions = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                timeZone: 'America/New_York'
            };
            const timeOptions = {
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit',
                hour12: true,
                timeZone: 'America/New_York'
            };
            
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', dateOptions);
            document.getElementById('lastUpdate').textContent = `Updated: ${now.toLocaleTimeString('en-US', timeOptions)} EST`;
        }


        function loadData() {
            if (isLoading) return;
            
            updateStatus(true);
            
            fetch('/api/current')
                .then(response => response.json())
                .then(data => {
                    updateUI(data);
                    updateStatus(false);
                })
                .catch(error => {
                    console.error('Error:', error);
                    updateStatus(false);
                    document.getElementById('lastUpdate').textContent = 'Error loading data';
                });
        }

        function refreshData() {
            if (isLoading) return;
            
            updateStatus(true);
            console.log('Refreshing data...');
            
            fetch('/api/refresh')
                .then(response => {
                    console.log('Refresh response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Refresh data received:', data);
                    if (data.error) {
                        console.error('Refresh API error:', data.error);
                    } else {
                        updateUI(data);
                    }
                    updateStatus(false);
                })
                .catch(error => {
                    console.error('Refresh fetch error:', error);
                    updateStatus(false);
                });
        }

        function shareToTwitter() {
            // Get current data for tweet
            fetch('/api/current')
                .then(response => response.json())
                .then(data => {
                    const originsFloor = formatNumber(data.origins?.floor_price_eth || 0, 4);
                    const undeadFloor = formatNumber(data.undead?.floor_price_eth || 0, 4);
                    const originsSupply = formatNumber(data.origins?.total_supply || 0);
                    const undeadSupply = formatNumber(data.undead?.total_supply || 0);
                    
                    const tweetText = `üî• GU Migration Tracker Update
üìä GU Origins: ${originsFloor} ETH floor (${originsSupply} supply)
üíÄ Genuine Undead: ${undeadFloor} ETH floor (${undeadSupply} supply)
üîÑ Migration analytics & trends live at:`;
                    
                    const url = window.location.href;
                    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}&url=${encodeURIComponent(url)}`;
                    window.open(twitterUrl, '_blank');
                })
                .catch(error => {
                    console.error('Error getting data for tweet:', error);
                    // Fallback tweet
                    const tweetText = `üìä Check out the live GU Migration Tracker - real-time analytics for GU Origins ‚Üí Genuine Undead migrations!`;
                    const url = window.location.href;
                    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}&url=${encodeURIComponent(url)}`;
                    window.open(twitterUrl, '_blank');
                });
        }

        function exportReport() {
            // Create a PDF export endpoint request
            const exportUrl = '/api/export-pdf';
            window.open(exportUrl, '_blank');
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Auto-refresh every 5 minutes
            setInterval(loadData, 5 * 60 * 1000);
        });
    </script>
</body>
</html>